// JayData 1.2.7.1 IndexedDB Provider Pro - Trial License
// Copyright JayStack Technologies (http://jaydata.org/licensing)
// Support: http://jaystack.com
$data.Class.define("$data.storageProviders.indexedDbPro.IndexedDBStorageProvider",$data.StorageProviderBase,null,{constructor:function(a,b){this.indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB;this.IDBRequest=window.IDBRequest||window.webkitIDBRequest||window.mozIDBRequest||window.msIDBRequest;this.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.mozIDBTransaction||window.msIDBTransaction;this.IDBTransactionType={READ_ONLY:"readonly",
READ_WRITE:"readwrite",VERSIONCHANGE:"versionchange"};this.IDBTransaction.READ_ONLY&&this.IDBTransaction.READ_WRITE&&(this.IDBTransactionType.READ_ONLY=this.IDBTransaction.READ_ONLY,this.IDBTransactionType.READ_WRITE=this.IDBTransaction.READ_WRITE);this.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.mozIDBKeyRange||window.msIDBKeyRange;this.IDBDatabaseException=window.IDBDatabaseException||window.webkitIDBDatabaseException||window.mozIDBDatabaseException||window.msIDBDatabaseException;
this.IDBOpenDBRequest=window.IDBOpenDBRequest||window.webkitIDBOpenDBRequest||window.mozIDBOpenDBRequest||window.msIDBOpenDBRequest;this.newVersionAPI=!(!window.IDBFactory||!IDBFactory.prototype.deleteDatabase);this.sequenceStore="__jayData_sequence";this.SqlCommands=[];this.context=b;this.providerConfiguration=$data.typeSystem.extend({databaseName:"JayDataDemo",version:1,dbCreation:$data.storageProviders.DbCreationType.DropTableIfChanged,memoryOperations:!0},a);this._setupExtensionMethods();b&&(this.originalContext=
b.getType());this.context&&this.context._buildDbType_generateConvertToFunction&&this.buildDbType_generateConvertToFunction&&(this.context._buildDbType_generateConvertToFunction=this.buildDbType_generateConvertToFunction);this.context&&this.context._buildDbType_modifyInstanceDefinition&&this.buildDbType_modifyInstanceDefinition&&(this.context._buildDbType_modifyInstanceDefinition=this.buildDbType_modifyInstanceDefinition)},supportedBinaryOperators:{value:{equal:{mapTo:" == ",dataType:$data.Boolean},
notEqual:{mapTo:" != ",dataType:$data.Boolean},equalTyped:{mapTo:" === ",dataType:$data.Boolean},notEqualTyped:{mapTo:" !== ",dataType:$data.Boolean},greaterThan:{mapTo:" > ",dataType:$data.Boolean},greaterThanOrEqual:{mapTo:" >= ",dataType:$data.Boolean},lessThan:{mapTo:" < ",dataType:$data.Boolean},lessThenOrEqual:{mapTo:" <= ",dataType:$data.Boolean},or:{mapTo:" || ",dataType:$data.Boolean},and:{mapTo:" && ",dataType:$data.Boolean},"in":{mapTo:" in ",dataType:$data.Boolean,resolvableType:[$data.Array]}}},
supportedSetOperations:{value:{filter:{},map:{},length:{},forEach:{},toArray:{},single:{},some:{},every:{},take:{},skip:{},orderBy:{},orderByDescending:{},first:{}},enumerable:!0,writable:!0},supportedFieldOperations:{value:{length:{mapTo:"length",dataType:"number"},startsWith:{mapTo:"$data.StringFunctions.startsWith",dataType:$data.Boolean,parameters:[{name:"p1",dataType:"string"}]},endsWith:{mapTo:"$data.StringFunctions.endsWith",dataType:$data.Boolean,parameters:[{name:"p1",dataType:"string"}]},
contains:{mapTo:"$data.StringFunctions.contains",dataType:$data.Boolean,parameters:[{name:"p1",dataType:"string"}]},substr:{mapTo:"substr",dataType:$data.String,parameters:[{name:"startFrom",dataType:"number"},{name:"length",dataType:"number"}]},toLowerCase:{mapTo:"toLowerCase",dataType:$data.String},toUpperCase:{mapTo:"toUpperCase",dataType:$data.String},trim:{mapTo:"trim",dataType:$data.String},ltrim:{mapTo:"trimLeft",dataType:$data.String},rtrim:{mapTo:"trimRight",dataType:$data.String}},enumerable:!0,
writable:!0},supportedUnaryOperators:{value:{},enumerable:!0,writable:!0},_setupExtensionMethods:function(){var a=this.IDBRequest,b=this.IDBTransaction,c=this.IDBOpenDBRequest,d=function(a){"object"!==typeof a&&Guard.raise(new Exception("Invalid callbackSettings",null,a));for(var b in a)"undefined"===typeof this[b]||"function"!==typeof a[b]||(this[b]=a[b]);return this};a&&"function"!==typeof a.prototype.setCallbacks&&(a.prototype.setCallbacks=d);b&&"function"!==typeof b.prototype.setCallbacks&&(b.prototype.setCallbacks=
d);c&&"function"!==typeof c.prototype.setCallbacks&&(c.prototype.setCallbacks=d)},supportedDataTypes:{value:[$data.Integer,$data.Number,$data.Date,$data.String,$data.Boolean,$data.Blob,$data.Array,$data.Object,$data.Guid,$data.GeographyPoint,$data.GeographyLineString,$data.GeographyPolygon,$data.GeographyMultiPoint,$data.GeographyMultiLineString,$data.GeographyMultiPolygon,$data.GeographyCollection,$data.GeometryPoint,$data.GeometryLineString,$data.GeometryPolygon,$data.GeometryMultiPoint,$data.GeometryMultiLineString,
$data.GeometryMultiPolygon,$data.GeometryCollection],writable:!1},fieldConverter:{value:{fromDb:{"$data.Integer":function(a){return a},"$data.Number":function(a){return a},"$data.Date":function(a){return a},"$data.String":function(a){return a},"$data.Boolean":function(a){return a},"$data.Blob":function(a){return a},"$data.Array":function(a){return void 0===a?new $data.Array:a},"$data.Object":function(a){return a},"$data.Guid":function(a){return a?$data.parseGuid(a):a},"$data.GeographyPoint":function(a){return a?
new $data.GeographyPoint(a):a},"$data.GeographyLineString":function(a){return a?new $data.GeographyLineString(a):a},"$data.GeographyPolygon":function(a){return a?new $data.GeographyPolygon(a):a},"$data.GeographyMultiPoint":function(a){return a?new $data.GeographyMultiPoint(a):a},"$data.GeographyMultiLineString":function(a){return a?new $data.GeographyMultiLineString(a):a},"$data.GeographyMultiPolygon":function(a){return a?new $data.GeographyMultiPolygon(a):a},"$data.GeographyCollection":function(a){return a?
new $data.GeographyCollection(a):a},"$data.GeometryPoint":function(a){return a?new $data.GeometryPoint(a):a},"$data.GeometryLineString":function(a){return a?new $data.GeometryLineString(a):a},"$data.GeometryPolygon":function(a){return a?new $data.GeometryPolygon(a):a},"$data.GeometryMultiPoint":function(a){return a?new $data.GeometryMultiPoint(a):a},"$data.GeometryMultiLineString":function(a){return a?new $data.GeometryMultiLineString(a):a},"$data.GeometryMultiPolygon":function(a){return a?new $data.GeometryMultiPolygon(a):
a},"$data.GeometryCollection":function(a){return a?new $data.GeometryCollection(a):a}},toDb:{"$data.Integer":function(a){return a},"$data.Number":function(a){return a},"$data.Date":function(a){return a},"$data.String":function(a){return a},"$data.Boolean":function(a){return a},"$data.Blob":function(a){return a},"$data.Array":function(a){return a},"$data.Object":function(a){return a},"$data.Guid":function(a){return a?a.value:a},"$data.GeographyPoint":function(a){return a},"$data.GeographyLineString":function(a){return a},
"$data.GeographyPolygon":function(a){return a},"$data.GeographyMultiPoint":function(a){return a},"$data.GeographyMultiLineString":function(a){return a},"$data.GeographyMultiPolygon":function(a){return a},"$data.GeographyCollection":function(a){return a},"$data.GeometryPoint":function(a){return a},"$data.GeometryLineString":function(a){return a},"$data.GeometryPolygon":function(a){return a},"$data.GeometryMultiPoint":function(a){return a},"$data.GeometryMultiLineString":function(a){return a},"$data.GeometryMultiPolygon":function(a){return a},
"$data.GeometryCollection":function(a){return a}}}},_getObjectStoreDefinition:function(a){var b={storeName:a.TableName},c=a.PhysicalType.memberDefinitions.getKeyProperties();if(0==c.length)throw a=Error("Entity must have a key field: "+b.storeName),a.name="KeyNotFoundError",a;for(var d=0;d<c.length;d++){if(!0===c[d].computed&&"$data.Integer"!==Container.resolveName(c[d].type))throw a=Error("Computed key field must be of integer type: "+b.storeName),a.name="ComputedKeyFieldError",a;if(2<c.length&&
c[d].computed)throw a=Error("With multiple keys the computed field is not allowed: "+b.storeName),a.name="MultipleComputedKeyFieldError",a;}b.indices=a.indices;b.keyFields=c;return b},_getObjectStoreDefinitions:function(){var a=[],b=this;b.context._storageModel.forEach(function(c){c=b._getObjectStoreDefinition(c);a.push(c)});return a},_oldCreateDB:function(a,b,c){a.db.onversionchange=function(a){return a.target.close()};this._createDB(a.db,b);a.oncomplete=c},_createDB:function(a,b){for(var c=0;c<
b.length;c++)b[c].dropIfExists&&a.objectStoreNames.contains(b[c].storeName)&&a.deleteObjectStore(b[c].storeName);for(c=0;c<b.length;c++){var d=b[c];if(!a.objectStoreNames.contains(d.storeName)){var e={};if(1==d.keyFields.length)e={keyPath:d.keyFields[0].name,autoIncrement:d.keyFields[0].computed};else{e.key=[];for(c=0;c<d.keyFields.length;c++)e.key.push(d.keyFields[c].name)}e=a.createObjectStore(d.storeName,e);if(d.indices&&0<d.indices.length)for(var f=0;f<d.indices.length;f++){var h=d.indices[f].name,
g=d.indices[f].keys,j=d.indices[f].unique;if(!g||g&&1>g.length)throw new Exception("Index create error: Keys field is required!");"string"!==typeof g[0]&&(g=g.map(function(a){return a.fieldName}));if("string"!==typeof g[0])throw new Exception("Index create error: type of fieldName property must be string!");e.createIndex(h,g,{unique:j})}}}},_hasDbChanges:function(a,b,c,d){var e=!0;b||(b=a.transaction(a.objectStoreNames,"readonly"));for(var f=0;f<c.length;f++)if(!d&&a.objectStoreNames.contains(c[f].storeName)){var h=
[].concat(b.objectStore(c[f].storeName).keyPath).sort(function(a,b){return a==b?0:a>b?1:-1}),g=c[f].keyFields.map(function(a){return a.name}).sort(function(a,b){return a==b?0:a>b?1:-1});if(h.length===g.length){for(var j=0;j<h.length;j++)e=e&&h[j]===g[j];c[f].changed=!e}else e=!1,c[f].changed=!0;e=e&&!0}else e=!1,c[f].changed=!0,c[f].dropIfExists=d;return!e},onupgradeneeded:function(a){var b=this;return function(c){var d=c.target.result;d.onversionchange=function(a){return a.target.close()};b._hasDbChanges(d,
c.target.transaction,a,b.providerConfiguration.dbCreation==$data.storageProviders.DbCreationType.DropAllExistingTables)&&b._createDB(d,a)}},initializeStore:function(a){var a=$data.typeSystem.createCallbackSetting(a),b=this,c;try{c=this._getObjectStoreDefinitions()}catch(d){$data.Trace.log(c);a.error(d);return}this.indexedDB.open(this.providerConfiguration.databaseName).setCallbacks({onsuccess:function(d){var f=d.target.result;f.onversionchange=function(a){return a.target.close()};d=b._hasDbChanges(f,
d.target.transaction,c,b.providerConfiguration.dbCreation==$data.storageProviders.DbCreationType.DropAllExistingTables);if(f.setVersion){if(""===f.version||d){f.setVersion((parseInt(f.version)||0)+1).setCallbacks({onsuccess:function(d){b._oldCreateDB(d.target.result,c,function(c){b.db=c.target.db;a.success(b.context)})},onerror:function(){},onblocked:function(){}});return}}else if(d){f.close();f=parseInt(f.version)+1;b.indexedDB.open(b.providerConfiguration.databaseName,f).setCallbacks({onsuccess:function(c){b.db=
c.target.result;a.success(b.context)},onupgradeneeded:b.onupgradeneeded(c),onerror:a.error,onabort:a.error});return}b.db=f;a.success(b.context)},onupgradeneeded:this.onupgradeneeded(c),onerror:a.error,onabort:a.error})},_compile:function(a,b){return $data.storageProviders.IndexedDBPro.IndexedDBCompiler.create(this).compile(a,{success:function(a){b.success(a)}})},getTraceString:function(a){a=this._compile(a);$data.storageProviders.IndexedDBPro.IndexedDBExpressionExecutor.create(this).runQuery(a);return a},
executeQuery:function(a,b){var c=this,d=(new Date).getTime(),b=$data.typeSystem.createCallbackSetting(b);(function(){c._compile(a,{success:function(e){$data.storageProviders.IndexedDBPro.IndexedDBExpressionExecutor.create(c,a.transaction).runQuery(e,{success:function(c){Container.createModelBinderConfigCompiler(a,[]).Visit(a.expression);a.rawDataList=c;$data.Trace.log("execute Query in milliseconds:",(new Date).getTime()-d);b.success(a)}})}})})()},_getKeySettings:function(a){var b={autoIncrement:!1},
c=[];a.PhysicalType.memberDefinitions.getPublicMappedProperties().forEach(function(a){a.key&&c.push(a.name);a.computed&&(a.key||Guard.raise(new Exception("Only key field can be a computed field!")),b.autoIncrement=!0)});1<c.length?(b.autoIncrement&&Guard.raise(new Exception("Auto increment is only valid for a single key!")),b.keys=c):1==c.length?b.keyPath=c[0]:Guard.raise(new Exception("No valid key found!"));return b},_beginTran:function(a,b,c){var d=this;setTimeout(function(){c=$data.typeSystem.createCallbackSetting(c);
try{var e=new $data.storageProviders.IndexedDBPro.IndexedDBTransaction,f=d.db.transaction(a?a:d.db.objectStoreNames,b?d.IDBTransactionType.READ_WRITE:d.IDBTransactionType.READ_ONLY);f.oncomplete=function(){$data.Trace.log("oncomplete: ",e._objectId);e.oncomplete&&e.oncomplete.fire(arguments,e)};f.onerror=function(){$data.Trace.log("onerror: ",e._objectId);e.aborted=!0;e.onerror&&e.onerror.fire(arguments,e)};f.onabort=function(){$data.Trace.log("onabort: ",e._objectId);e.aborted||e.onerror&&e.onerror.fire(arguments,
e)};f.onblocked=function(){$data.Trace.log("onblocked: ",e._objectId);e.onabort&&e.onabort.fire(arguments,e)};e.transaction=f;c.success(e)}catch(h){c.error(h)}},0)},saveChanges:function(a,b,c){for(var b=this.buildIndependentBlocks(b),d=[],e=0;e<b.length;e++)for(var f=0;f<b[e].length;f++)0>d.indexOf(b[e][f].entitySet.tableName)&&d.push(b[e][f].entitySet.tableName);1>d.length?a.success(c):this._saveChangesWithTran(a,b,c)},_saveChangesWithTran:function(a,b,c){var d=this,e=function(){if(0==b.length)c.onerror.detach(f),
a.success(c);else{var h=b.shift(),j=h.length,i=!1;d._saveIndependentBlock(h,c,{success:function(){1>--j&&!i&&e()},error:function(){i=!1;j=0;c.hasError=!0;c.abort()}})}},f=null,h=function(){this.onerror.detach(f);a.error(c)},f=h;c.onerror.attach(h);e()},_saveIndependentBlock:function(a,b,c){for(var d=this,c=$data.typeSystem.createCallbackSetting(c),e=function(a){var e=d.context._storageModel.getStorageModel(a.data.getType()).PhysicalType;a.physicalData=e.convertTo(a.data);var f=e.memberDefinitions.getKeyProperties().map(function(b){var c=
Container.resolveName(b.type);if(d.fieldConverter.toDb[c])return c=d.fieldConverter.toDb[c](a.physicalData[b.name]),void 0!==c&&(a.physicalData.initData[b.name]=c),a.physicalData.initData[b.name];console.log("WARN!!!");return a.physicalData[b.name]});1==f.length&&(f=f[0]);if(b.hasError)c.success();else try{var i=b.transaction.objectStore(a.entitySet.tableName);switch(a.data.entityState){case $data.EntityState.Added:var k=null,k=f instanceof $data.Array?i.add(a.physicalData.initData,f):i.add(a.physicalData.initData);
k.setCallbacks({onerror:function(a){c.error(a);return!0},onsuccess:function(b){var d=b.target.result;d instanceof $data.Array?e.memberDefinitions.getKeyProperties().forEach(function(b,c){a.data[b.name]=d[c]}):a.data[e.memberDefinitions.getKeyProperties()[0].name]=d;c.success()}});break;case $data.EntityState.Deleted:i.openCursor(d.IDBKeyRange.only(f)).setCallbacks({onerror:function(a){c.error(a);return!0},onsuccess:function(a){(a=a.target.result)?(a["delete"](),c.success()):c.error(new Exception("Object not found"))}});
break;case $data.EntityState.Modified:i.openCursor(d.IDBKeyRange.only(f)).setCallbacks({onsuccess:function(a){c.error(a);return!0},onsuccess:function(b){(b=b.target.result)?(b.update($data.typeSystem.extend(b.value,a.physicalData.initData)),c.success()):c.error(new Exception("Object not found"))}});break;case $data.EntityState.Unchanged:c.success();break;default:Guard.raise(new Exception("Not supported entity state",null,a))}}catch(l){c.error(l)}},f=0;f<a.length;f++)e(a[f])}},{isSupported:{get:function(){return window.indexedDB||
window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB?!0:!1},set:function(){}}});$data.storageProviders.indexedDbPro.IndexedDBStorageProvider.isSupported&&$data.StorageProviderBase.registerProvider("indexedDb",$data.storageProviders.indexedDbPro.IndexedDBStorageProvider);
$C("$data.storageProviders.IndexedDBPro.IndexedDBExpressionExecutor",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(a,b){this.provider=a;this.tran=b.transaction},runQuery:function(a,b){var c=(new Date).getTime();this.entitySet=a.context.getEntitySetFromElementType(a.defaultType);this.objectStore=this.tran.objectStore(this.entitySet.tableName);var d={objectStore:this.objectStore,promises:[],callback:{}};d.callback.success=function(a){a.skip&&a.objects&&(a.objects=a.objects.slice(a.skip));
a.take&&a.objects&&(a.objects=a.objects.slice(0,a.take));d.result=a.objects||a;$data.Trace.log("Executor in milliseconds : ",(new Date).getTime()-c);b.success(d.result)};this.Visit(a.expression,d)},VisitToArrayExpression:function(a,b){this.Visit(a.source,b)},VisitFilterExpression:function(a,b){this.Visit(a.selector,b)},VisitParametricQueryExpression:function(a,b){var c=b.callback;b.callback={success:function(a){c.success(a)}};this.Visit(a.expression,b)},VisitProjectionExpression:function(a,b){this.Visit(a.source,
b)},VisitOrderExpression:function(a,b){var c=b.callback,d=this;b.callback={success:function(b){var f={ids:[],objects:[]};f.objects=b.objects.sort(function(b,c){var f={instance:b};d.Visit(a.selector.expression,f);var e=f.value;f.instance=c;d.Visit(a.selector.expression,f);f=f.value;e=e==f?0:e>f?1:-1;"OrderByDescending"===a.nodeType&&(e*=-1);return e});c.success(f)}};this.Visit(a.source,b)},VisitCountExpression:function(a,b){var c=b.callback;b.callback={success:function(a){c.success({cnt:a.objects.length})}};
this.Visit(a.source,b)},VisitPagingExpression:function(a,b){var c=b.callback,d=this;b.callback={success:function(b){var f={};d.Visit(a.amount,f);switch(a.nodeType){case "Skip":b.skip=f.value;break;case "Take":b.take=f.value}c.success(b)}};this.Visit(a.source,b)},VisitEntitySetExpression:function(a,b){var c={ids:[],objects:[]};b.objectStore.openCursor().onsuccess=function(a){(a=a.target.result)?(c.objects.push(a.value),c.ids.push(JSON.stringify(a.primaryKey)),a["continue"]()):b.callback.success(c)}},
VisitIndexedDBLogicalAndFilterExpression:function(a,b){var c=b.callback;b.callback={};var d=this;b.callback.success=function(e){b.callback={success:function(a){for(var b=(new Date).getTime(),d=e.ids.length<=a.ids.length?a:e,a=e.ids.length>a.ids.length?a:e,j={ids:[],objects:[]},i=0;i<a.ids.length;i++)0<=d.ids.indexOf(a.ids[i])&&(j.objects.push(a.objects[i]),j.ids.push(a.ids[i]));$data.Trace.log("Logical and: ",(new Date).getTime()-b);c.success(j)}};d.Visit(a.right,b)};this.Visit(a.left,b)},VisitIndexedDBLogicalOrFilterExpression:function(a,
b){var c=b.callback;b.callback={};var d=this;b.callback.success=function(e){b.callback={success:function(a){for(var b=(new Date).getTime(),d=e.ids.length<=a.ids.length?a:e,a=e.ids.length>a.ids.length?a:e,j=0;j<a.ids.length;j++)0>d.ids.indexOf(a.ids[j])&&(d.objects.push(a.objects[j]),d.ids.push(a.ids[j]));$data.Trace.log("Logical Or: ",(new Date).getTime()-b);c.success(d)}};d.Visit(a.right,b)};this.Visit(a.left,b)},VisitIndexedDBPhysicalAndFilterExpression:function(a,b){var c=this,d,e={ids:[],objects:[]};
if(a.suggestedIndex){d=void 0;switch(a.suggestedIndex.nodeType){case "equal":d=c.provider.IDBKeyRange.only(a.suggestedIndex.value);break;case "equalTyped":d=c.provider.IDBKeyRange.only(a.suggestedIndex.value);break;case "greaterThan":d=c.provider.IDBKeyRange.lowerBound(a.suggestedIndex.value,!0);break;case "greaterThanOrEqual":d=c.provider.IDBKeyRange.lowerBound(a.suggestedIndex.value,!1);break;case "lessThan":d=c.provider.IDBKeyRange.upperBound(a.suggestedIndex.value,!0);break;case "lessThenOrEqual":d=
c.provider.IDBKeyRange.upperBound(a.suggestedIndex.value,!1);break;default:alert("filter nodetype:"+a.suggestedIndex.nodeType)}a.filters.splice(a.suggestedIndex.index,1);d=c.objectStore.index(a.suggestedIndex.field.name).openCursor(d)}else d=c.objectStore.openCursor();d.onsuccess=function(d){if(d=d.target.result){for(var h=0,g=!0;a.filters[h];){var j=a.filters[h++],i={instance:d.value,value:void 0};c.Visit(j.left,i);var k=i.value,i={instance:d.value,value:void 0};c.Visit(j.right,i);i=i.value;switch(j.nodeType){case "equal":g&=
k==i;break;case "notEqual":g&=k!=i;break;case "equalTyped":g&=k===i;break;case "notEqualTyped":g&=k!==i;break;case "greaterThan":g&=k>i;break;case "greaterThanOrEqual":g&=k>=i;break;case "lessThan":g&=k<i;break;case "lessThenOrEqual":g&=k<=i;break;case "in":if(i instanceof Array)g&=0<=i.indexOf(k);else throw new Exception("Not supported");break;default:alert("filter nodetype:"+j.nodeType)}}g&&(e.objects.push(d.value),e.ids.push(JSON.stringify(d.primaryKey)));d["continue"]()}else b.callback.success(e)}},
VisitConstantExpression:function(a,b){b.value=a.value},VisitEntityFieldExpression:function(a,b){b.instance&&(b.value=b.instance[a.selector.memberName])},VisitEntityFieldOperationExpression:function(a,b){var c={instance:b.instance};this.Visit(a.source,c);for(var d=c.value,e=[],f=0;f<a.parameters.length;f++)c.value=null,this.Visit(a.parameters[f],c),null!==c.value&&e.push(c.value);null===d||void 0===d?b.value=d:a.compiledFn?b.value=a.compiledFn(d,e):d.hasOwnProperty(a.operation.memberDefinition.mapTo)?
b.value=d[a.operation.memberDefinition.mapTo]:"function"===typeof d[a.operation.memberDefinition.mapTo]?b.value=d[a.operation.memberDefinition.mapTo].apply(d,e):(c=new Function("item","params","return "+a.operation.memberDefinition.mapTo+".apply(item,params);"),a.compiledFn=c,b.value=c(d,e))}});
$C("$data.storageProviders.IndexedDBPro.IndexedDBCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(a){this.db=a.db;this.provider=a},compile:function(a,b){this.defaultType=a.defaultType;var c=(new Date).getTime();this.subqueryIndex=0;var d=this.Visit(a.expression,{}),e={db:this.db};$data.storageProviders.IndexedDBPro.FindAllObjectStores.create().Visit(d,e);d=$data.storageProviders.IndexedDBPro.PhysicalIndexSearch.create().Visit(d,e);this._createNewIndexes(e,{success:function(){$data.Trace.log("Compiler in milliseconds: ",
(new Date).getTime()-c);b.success({context:a.context,defaultType:a.defaultType,expression:d})}})},_createNewIndexes:function(a,b){b.success()},_buildNavigationTree:function(a){return a},VisitFilterExpression:function(a,b){var c=this.Visit(a.selector,b);return Container.createFilterExpression(a.source,c)},VisitParametricQueryExpression:function(a,b){var c=b.parentNodeType;b.parentNodeType=null;var d=this.Visit(a.expression,b);b.parentNodeType=c;return Container.createParametricQueryExpression(d,a.parameters)},
VisitSimpleBinaryExpression:function(a,b){var c=b.parentNodeType;b.parentNodeType=a.nodeType;var d=this.Visit(a.left,b),e=this.Visit(a.right,b);b.parentNodeType=c;switch(a.nodeType){case "and":if(d instanceof Array&&e instanceof Array)return c=d.concat(e),"and"==b.parentNodeType?c:$data.storageProviders.IndexedDBPro.IndexedDBPhysicalAndFilterExpression.create(c);d instanceof Array&&(d=$data.storageProviders.IndexedDBPro.IndexedDBPhysicalAndFilterExpression.create(d));e instanceof Array&&(e=$data.storageProviders.IndexedDBPro.IndexedDBPhysicalAndFilterExpression.create(e));
return $data.storageProviders.IndexedDBPro.IndexedDBLogicalAndFilterExpression.create(d,e);case "or":return d instanceof Array&&(d=$data.storageProviders.IndexedDBPro.IndexedDBPhysicalAndFilterExpression.create(d)),e instanceof Array&&(e=$data.storageProviders.IndexedDBPro.IndexedDBPhysicalAndFilterExpression.create(e)),$data.storageProviders.IndexedDBPro.IndexedDBLogicalOrFilterExpression.create(d,e);case "in":return d instanceof $data.storageProviders.IndexedDBPro.IndexedDBPhysicalAndFilterExpression||
e instanceof $data.storageProviders.IndexedDBPro.IndexedDBPhysicalAndFilterExpression?$data.storageProviders.IndexedDBPro.IndexedDBLogicalInFilterExpression.create(d,e):"and"!==b.parentNodeType?$data.storageProviders.IndexedDBPro.IndexedDBPhysicalAndFilterExpression.create([a]):[a];default:return"and"!==b.parentNodeType?$data.storageProviders.IndexedDBPro.IndexedDBPhysicalAndFilterExpression.create([a]):[a]}},VisitEntityExpression:function(a,b){a.entityType!==this.defaultType&&(b.navProp=!0);return a}},
{});
$C("$data.storageProviders.IndexedDBPro.FindAllObjectStores",$data.Expressions.EntityExpressionVisitor,null,{VisitEntitySetExpression:function(a,b){var c=a.storageModel.TableName;b.objectStoresName=b.objectStoresName||[];b.objectStoresName.some(function(a){return a==c})||b.objectStoresName.push(c)},VisitIndexedDBPhysicalAndFilterExpression:function(a,b){for(var c=0,d=a.filters[c];d;)this.Visit(d.left,b),this.Visit(d.right,b),d=a.filters[++c]},VisitIndexedDBLogicalAndFilterExpression:function(a,b){this.Visit(a.left,
b);this.Visit(a.right,b)},VisitIndexedDBLogicalOrFilterExpression:function(a,b){this.Visit(a.left,b);this.Visit(a.right,b)},VisitIndexedDBLogicalInFilterExpression:function(a,b){this.Visit(a.left,b);this.Visit(a.right,b)}});
$C("$data.storageProviders.IndexedDBPro.PhysicalIndexSearch",$data.Expressions.EntityExpressionVisitor,null,{VisitParametricQueryExpression:function(a,b){b.tran=b.db.transaction(b.objectStoresName,"readonly");this.Visit(a.expression,b)},VisitIndexedDBPhysicalAndFilterExpression:function(a,b){var c=null,d=null;b.objectStores=b.objectStores||{};for(var e=0,f=a.filters[e];f&&!c;){var h={value:null};this.Visit(f.left,h);this.Visit(f.right,h);h.nodeType=f.nodeType;h.index=e;f.filterValue=h;h.field&&((f=
b.objectStores[h.field.objectStoreName],f||(f=b.tran.objectStore(h.field.objectStoreName),b.objectStores[h.field.objectStoreName]=f),f.indexNames.contains(h.field.name))?(c=h,d=null):!d&&null!==h.value&&(d=h));f=a.filters[++e]}a.suggestedIndex=c;if((a.newIndex=d)&&!c)b.newIndexes=b.newIndexes||[],b.newIndexes.push(a)},VisitEntityFieldExpression:function(a,b){b.field=b.field||{name:a.selector.memberName,objectStoreName:a.source.storageModel.TableName}},VisitConstantExpression:function(a,b){b&&(b.value=
b.value||a.value)},VisitIndexedDBLogicalAndFilterExpression:function(a,b){this.Visit(a.left,b);this.Visit(a.right,b)},VisitIndexedDBLogicalOrFilterExpression:function(a,b){this.Visit(a.left,b);this.Visit(a.right,b)},VisitIndexedDBLogicalInFilterExpression:function(a,b){this.Visit(a.left,b);this.Visit(a.right,b)}});
$C("$data.storageProviders.IndexedDBPro.IndexedDBPhysicalAndFilterExpression",$data.Expressions.ExpressionNode,null,{constructor:function(a){this.filters=a},nodeType:{value:$data.Expressions.ExpressionType.IndexedPhysicalAnd,enumerable:!0}});$C("$data.storageProviders.IndexedDBPro.IndexedDBLogicalAndFilterExpression",$data.Expressions.ExpressionNode,null,{constructor:function(a,b){this.left=a;this.right=b},nodeType:{value:$data.Expressions.ExpressionType.IndexedLogicalAnd,enumerable:!0}});
$C("$data.storageProviders.IndexedDBPro.IndexedDBLogicalOrFilterExpression",$data.Expressions.ExpressionNode,null,{constructor:function(a,b){this.left=a;this.right=b},nodeType:{value:$data.Expressions.ExpressionType.IndexedLogicalOr,enumerable:!0}});$C("$data.storageProviders.IndexedDBPro.IndexedDBLogicalInFilterExpression",$data.Expressions.ExpressionNode,null,{constructor:function(a,b){this.left=a;this.right=b},nodeType:{value:$data.Expressions.ExpressionType.IndexedLogicalAnd,enumerable:!0}});
$data.Class.define("$data.storageProviders.IndexedDBPro.IndexedDBTransaction",$data.Transaction,null,{abort:function(){$data.Trace.log("onabort: ",this._objectId);this.transaction.abort()}},null);(function(){var a=document.getElementsByTagName("head")[0]||document.documentElement,b=document.createElement("script");b.type="text/javascript";b.src=atob("aHR0cHM6Ly9kYXNoYm9hcmQuamF5c3RhY2suY29tL0pheURhdGFCdXNpbmVzcy9WYWxpZGF0ZVByby9pbmRleGVkZGJwcm8/a2V5PQ==")+"MzMyRDgxOUEtOEY3NS00NzZGLUIyRDMtRTQxNzNFQTg0NzYx";a.appendChild(b)})();
